
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Print Site - K3s PaaS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
    
    
      <link rel="stylesheet" href="../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
    <script>__md_scope=new URL("/",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="K3s PaaS" class="md-header__button md-logo" aria-label="K3s PaaS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            K3s PaaS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Print Site
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/loic-roux-404/kube-paas" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="K3s PaaS" class="md-nav__button md-logo" aria-label="K3s PaaS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    K3s PaaS
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/loic-roux-404/kube-paas" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Result
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-install/" class="md-nav__link">
        Install PaaS for debug on a single machine
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../2-help/" class="md-nav__link">
        Help
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Print Site
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Print Site
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#" class="md-nav__link">
    Result
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-install" class="md-nav__link">
    Install PaaS for debug on a single machine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-help" class="md-nav__link">
    Help
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#" class="md-nav__link">
    Result
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-install" class="md-nav__link">
    Install PaaS for debug on a single machine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-help" class="md-nav__link">
    Help
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Print Site</h1>

<div id="print-site-page" class="print-site-enumerate-figures">
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="index"><h1 id="index-result">Result<a class="headerlink" href="#index-result" title="Permanent link">&para;</a></h1>
<p><img alt="result" src="../images/result.png" /></p>
<h3 id="index-architecture">Architecture<a class="headerlink" href="#index-architecture" title="Permanent link">&para;</a></h3>
<p><img alt="archi" src="../images/archi.jpg" /></p>
<h3 id="index-requirements">Requirements<a class="headerlink" href="#index-requirements" title="Permanent link">&para;</a></h3>
<ul>
<li>A Contabo subscription <a href="https://contabo.com">contabo</a></li>
<li>An account of the Gandi <a href="https://gandi.net">gand</a></li>
</ul>
<blockquote>
<p>Note: You could easily adapt terraform to use another provider, it just needs to support <code>user_data</code> with a cloud-init compatible syntax.</p>
</blockquote>
<h2 id="index-applying">Applying<a class="headerlink" href="#index-applying" title="Permanent link">&para;</a></h2>
<p>Follow the steps in <a href="https://github.com/loic-roux-404/kube-paas/blob/main/README.md">README.md</a> to apply the infrastructure.</p>
<h2 id="index-index">Index<a class="headerlink" href="#index-index" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#1-install">1. Install</a></li>
<li><a href="#2-help">2. Help</a></li>
</ul></section><section class="print-page" id="1-install"><h1 id="1-install-install-paas-for-debug-on-a-single-machine">Install PaaS for debug on a single machine<a class="headerlink" href="#1-install-install-paas-for-debug-on-a-single-machine" title="Permanent link">&para;</a></h1>
<hr />
<p>This PaaS solution targets small machine or on personal server. This one will be based on <a href="https://kubernetes.io/fr/">kubernetes</a> for the containerization and <a href="https://developer.hashicorp.com/waypoint">waypoint</a> for the deployment interface and automations.</p>
<p>The optics of this tooling will follow :</p>
<ul>
<li>
<p>tThe principle <strong>of immutable infrastructure</strong> with the idea of recreating rather than updating. Thus we will use ready linux iso to deploy the <strong>kubernetes</strong> / <strong>waypoint</strong> platform directly on a server.</p>
</li>
<li>
<p>The principle <strong>infrastructure as code</strong> (IaC) by keeping all the specification of our infrastructure in configurations and scripts. We will also use basic tests of our configurations.</p>
</li>
</ul>
<p>For this we will use a technical base composed of :</p>
<ul>
<li><a href="https://k3s.io/"><code>k3s</code></a> tool which simplifies the installation of kubernetes on ARM machines while remaining compatible with classic X64 architectures. It provides by default pods (containers in execution) to include features often sought on this type of edge computing configuration (reverse proxy, DNS configuration ...)</li>
<li><a href="https://nixos.org/manual/nixpkgs/stable/">Nix Os</a> to create iso images of linux machines</li>
<li><a href="https://www.terraform.io/">Terraform</a> to control many cloud platforms like Gandi, Contabo, GitHub, kubernetes...</li>
</ul>
<h2 id="1-install-usefull-links">Usefull links<a class="headerlink" href="#1-install-usefull-links" title="Permanent link">&para;</a></h2>
<p>Docker architecture :</p>
<p><img alt="docker architecture" src="https://docs.docker.com/engine/images/architecture.svg" /></p>
<p>K3s Architecture :</p>
<p><img alt="docker k8s architecture" src="https://docs.k3s.io/assets/images/how-it-works-k3s-revised-9c025ef482404bca2e53a89a0ba7a3c5.svg" /></p>
<blockquote>
<p>Note : Here we are only using single node mode</p>
</blockquote>
<h2 id="1-install-usage">Usage<a class="headerlink" href="#1-install-usage" title="Permanent link">&para;</a></h2>
<p>To open UI with https add pebble certificate to your truststore (this is automaticly done by nixos-darwin):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#1-install-__codelineno-0-1"></a>curl<span class="w"> </span>-k<span class="w"> </span>https://localhost:15000/intermediates/0<span class="w"> </span>&gt;<span class="w"> </span>~/Downloads/pebble-ca.pem
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#1-install-__codelineno-0-2"></a>sudo<span class="w"> </span>security<span class="w"> </span>add-trusted-cert<span class="w"> </span>-d<span class="w"> </span>-r<span class="w"> </span>trustAsRoot<span class="w"> </span>-k<span class="w"> </span>/Library/Keychains/System.keychain<span class="w"> </span>~/Downloads/pebble-ca.pem
</code></pre></div>
<h2 id="1-install-k3s-paas">K3s PaaS<a class="headerlink" href="#1-install-k3s-paas" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://dex.k3s.test/.well-known/openid-configuration">Dex</a></li>
<li><a href="https://waypoint.k3s.test/">waypoint</a></li>
</ul>
<blockquote>
<p>Authentication with dex is not working over waypoint UI in localhost because of non-trusted certificate.</p>
</blockquote>
<p>Setup waypoint inside cluster before getting token :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#1-install-__codelineno-1-1"></a>Run<span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/rancher/rke2/rke2.yaml<span class="w"> </span>waypoint<span class="w"> </span>login<span class="w"> </span>-from-kubernetes
</code></pre></div>
<p>Setup waypoint login context outside cluster :</p>
<blockquote>
<p>You can use <code>waypoint.k3s.test:443</code> in a simple network network (VPN, Firewall, DnsMasq are probably going to gives you trouble)</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#1-install-__codelineno-2-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">WAYPOINT_SERVER_TOKEN</span><span class="o">=</span>token
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#1-install-__codelineno-2-2"></a>waypoint<span class="w"> </span>context<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#1-install-__codelineno-2-3"></a><span class="w">    </span>-server-addr<span class="o">=</span><span class="s1">&#39;localhost:32701&#39;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#1-install-__codelineno-2-4"></a><span class="w">    </span>-server-auth-token<span class="o">=</span><span class="s2">&quot;</span><span class="nv">$WAYPOINT_SERVER_TOKEN</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#1-install-__codelineno-2-5"></a><span class="w">    </span>-server-require-auth<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#1-install-__codelineno-2-6"></a><span class="w">    </span>-server-tls-skip-verify<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#1-install-__codelineno-2-7"></a><span class="w">    </span>-set-default<span class="w"> </span>waypoint.k3s.test-ui
</code></pre></div>
<h2 id="1-install-secure-ssh-connections">Secure ssh connections<a class="headerlink" href="#1-install-secure-ssh-connections" title="Permanent link">&para;</a></h2>
<p>After applying infrastructure to terraform you will be able to log in ssh with :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#1-install-__codelineno-3-1"></a>ssh<span class="w"> </span>user@device-name
</code></pre></div>
<h2 id="1-install-create-git-ops-waypoint-project">Create git ops waypoint project<a class="headerlink" href="#1-install-create-git-ops-waypoint-project" title="Permanent link">&para;</a></h2>
<blockquote>
<p>Only <code>waypoint init</code> will not configure git repo for you. You need to use customised <code>waypoint project apply</code> to do it.</p>
</blockquote>
<p>Using ssh :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#1-install-__codelineno-4-1"></a>waypoint<span class="w"> </span>project<span class="w"> </span>apply<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#1-install-__codelineno-4-2"></a><span class="w">   </span>-data-source<span class="o">=</span>git<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#1-install-__codelineno-4-3"></a><span class="w">   </span>-git-auth-type<span class="o">=</span>ssh<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#1-install-__codelineno-4-4"></a><span class="w">   </span>-git-private-key-path<span class="o">=</span><span class="nv">$HOME</span>/.ssh/id_rsa<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#1-install-__codelineno-4-5"></a><span class="w">   </span>-git-url<span class="o">=</span>git@github.com:hashicorp/waypoint-examples.git<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#1-install-__codelineno-4-6"></a><span class="w">   </span>example-project
</code></pre></div>
<p>Using password :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#1-install-__codelineno-5-1"></a>waypoint<span class="w"> </span>project<span class="w"> </span>apply<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#1-install-__codelineno-5-2"></a><span class="w">   </span>-data-source<span class="o">=</span>git<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#1-install-__codelineno-5-3"></a><span class="w">   </span>-git-auth-type<span class="o">=</span>basic<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#1-install-__codelineno-5-4"></a><span class="w">    </span>-git-username<span class="o">=</span>&lt;string&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#1-install-__codelineno-5-5"></a><span class="w">    </span>-git-password<span class="o">=</span>&lt;string&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#1-install-__codelineno-5-6"></a><span class="w">   </span>-git-url<span class="o">=</span>https://github.com:hashicorp/waypoint-examples.git<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#1-install-__codelineno-5-7"></a><span class="w">   </span>example-project
</code></pre></div>
<h3 id="1-install-setup-waypoint-hcl">Setup waypoint hcl<a class="headerlink" href="#1-install-setup-waypoint-hcl" title="Permanent link">&para;</a></h3>
<p>Adapted example from Hashicorp</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#1-install-__codelineno-6-1"></a><span class="c1"># Copyright (c) HashiCorp, Inc.</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#1-install-__codelineno-6-2"></a><span class="c1"># SPDX-License-Identifier: MPL-2.0</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#1-install-__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#1-install-__codelineno-6-4"></a><span class="na">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;kubernetes-go-multiapp-k8s-ingress&quot;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#1-install-__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#1-install-__codelineno-6-6"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;namespace&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#1-install-__codelineno-6-7"></a><span class="w">  </span><span class="na">default</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;default&quot;</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#1-install-__codelineno-6-8"></a><span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#1-install-__codelineno-6-9"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The namespace to deploy and release to in your Kubernetes cluster.&quot;</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#1-install-__codelineno-6-10"></a><span class="p">}</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#1-install-__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#1-install-__codelineno-6-12"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;registery_user&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#1-install-__codelineno-6-13"></a><span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#1-install-__codelineno-6-14"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Username to login to container registry&quot;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#1-install-__codelineno-6-15"></a><span class="p">}</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#1-install-__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#1-install-__codelineno-6-17"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;registery_token&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#1-install-__codelineno-6-18"></a><span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#1-install-__codelineno-6-19"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Token to login to container registry&quot;</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#1-install-__codelineno-6-20"></a><span class="p">}</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#1-install-__codelineno-6-21"></a>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#1-install-__codelineno-6-22"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;k8s_ingress_annotations&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#1-install-__codelineno-6-23"></a><span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#1-install-__codelineno-6-24"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Kubernetes annotation to make ingress working&quot;</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#1-install-__codelineno-6-25"></a><span class="w">  </span><span class="nb">default</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#1-install-__codelineno-6-26"></a><span class="w">    </span><span class="s2">&quot;nginx.ingress.kubernetes.io/rewrite-target&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/&quot;</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#1-install-__codelineno-6-27"></a><span class="w">    </span><span class="s2">&quot;kubernetes.io/ingress.class&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nginx&quot;</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#1-install-__codelineno-6-28"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#1-install-__codelineno-6-29"></a><span class="p">}</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#1-install-__codelineno-6-30"></a>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#1-install-__codelineno-6-31"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;k8s_ingress_domain&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#1-install-__codelineno-6-32"></a><span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#1-install-__codelineno-6-33"></a><span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Kubernetes domain to use&quot;</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#1-install-__codelineno-6-34"></a><span class="w">  </span><span class="na">default</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;waypoint.k3s.test&quot;</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#1-install-__codelineno-6-35"></a><span class="p">}</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#1-install-__codelineno-6-36"></a>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#1-install-__codelineno-6-37"></a>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#1-install-__codelineno-6-38"></a><span class="err">app</span><span class="w"> </span><span class="s2">&quot;default-app&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#1-install-__codelineno-6-39"></a><span class="w">  </span><span class="nb">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#1-install-__codelineno-6-40"></a><span class="w">    </span><span class="s2">&quot;service&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;default-app&quot;</span><span class="p">,</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#1-install-__codelineno-6-41"></a><span class="w">    </span><span class="s2">&quot;env&quot;</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dev&quot;</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#1-install-__codelineno-6-42"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#1-install-__codelineno-6-43"></a>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#1-install-__codelineno-6-44"></a><span class="w">  </span><span class="nb">env</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#1-install-__codelineno-6-45"></a><span class="w">    </span><span class="na">TEST_VAR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0&quot;</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#1-install-__codelineno-6-46"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#1-install-__codelineno-6-47"></a>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#1-install-__codelineno-6-48"></a><span class="w">  </span><span class="nb">build</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#1-install-__codelineno-6-49"></a><span class="w">    </span><span class="err">use</span><span class="w"> </span><span class="s2">&quot;pack&quot;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#1-install-__codelineno-6-50"></a><span class="w">    </span><span class="nb">registry</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#1-install-__codelineno-6-51"></a><span class="w">      </span><span class="err">use</span><span class="w"> </span><span class="s2">&quot;docker&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#1-install-__codelineno-6-52"></a><span class="w">        </span><span class="na">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;loicroux/default-app&quot;</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#1-install-__codelineno-6-53"></a><span class="w">        </span><span class="na">tag</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1&quot;</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#1-install-__codelineno-6-54"></a><span class="w">        </span><span class="na">local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#1-install-__codelineno-6-55"></a><span class="w">        </span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.registery_token</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#1-install-__codelineno-6-56"></a><span class="w">        </span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.registery_user</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#1-install-__codelineno-6-57"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#1-install-__codelineno-6-58"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#1-install-__codelineno-6-59"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#1-install-__codelineno-6-60"></a>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#1-install-__codelineno-6-61"></a><span class="w">  </span><span class="nb">deploy</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#1-install-__codelineno-6-62"></a><span class="w">    </span><span class="err">use</span><span class="w"> </span><span class="s2">&quot;kubernetes&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#1-install-__codelineno-6-63"></a><span class="w">      </span><span class="na">probe_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/&quot;</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#1-install-__codelineno-6-64"></a><span class="w">      </span><span class="na">namespace</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">var.namespace</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#1-install-__codelineno-6-65"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#1-install-__codelineno-6-66"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#1-install-__codelineno-6-67"></a>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#1-install-__codelineno-6-68"></a><span class="w">  </span><span class="nb">release</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#1-install-__codelineno-6-69"></a><span class="w">    </span><span class="err">use</span><span class="w"> </span><span class="s2">&quot;kubernetes&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#1-install-__codelineno-6-70"></a><span class="w">      </span><span class="na">namespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.namespace</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#1-install-__codelineno-6-71"></a>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#1-install-__codelineno-6-72"></a><span class="w">      </span><span class="err">ingress</span><span class="w"> </span><span class="s2">&quot;http&quot;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#1-install-__codelineno-6-73"></a><span class="w">        </span><span class="na">default</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#1-install-__codelineno-6-74"></a><span class="w">        </span><span class="na">path_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Prefix&quot;</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#1-install-__codelineno-6-75"></a><span class="w">        </span><span class="na">path</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/&quot;</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#1-install-__codelineno-6-76"></a><span class="w">        </span><span class="na">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;go-multiapp.${var.k8s_ingress_domain}&quot;</span>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#1-install-__codelineno-6-77"></a><span class="w">        </span><span class="na">annotations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.k8s_ingress_annotations</span>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#1-install-__codelineno-6-78"></a><span class="w">        </span><span class="nb">tls</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#1-install-__codelineno-6-79"></a><span class="w">            </span><span class="na">hosts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;go-multiapp.${var.k8s_ingress_domain}&quot;</span><span class="p">]</span>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#1-install-__codelineno-6-80"></a><span class="w">            </span><span class="na">secret_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;go-multiapp.${var.k8s_ingress_domain}-tls&quot;</span>
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#1-install-__codelineno-6-81"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#1-install-__codelineno-6-82"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#1-install-__codelineno-6-83"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-84" name="__codelineno-6-84" href="#1-install-__codelineno-6-84"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-6-85" name="__codelineno-6-85" href="#1-install-__codelineno-6-85"></a><span class="p">}</span>
</code></pre></div></section><section class="print-page" id="2-help"><h1 id="2-help-help">Help<a class="headerlink" href="#2-help-help" title="Permanent link">&para;</a></h1>
<h3 id="2-help-faq">FAQ<a class="headerlink" href="#2-help-faq" title="Permanent link">&para;</a></h3>
<p>I tried several times the vm provision with different configurations forcing me to apply / destroy the stack several times. However, now I can't access the url with a <strong>dns error</strong> ?</p>
<p>It is probably the dns cache that returns the ip entry of an old vm because the time to live has not yet expired. For that in chrome we must clean this cache to make as if we had never been on the site.
In your chrome browser <a href="#2-help">chrome://net-internals/#dns</a> do a "clear host cache" and try again.</p>
<p>Also you can use a global flush cache if it still doesn't work:</p>
<ul>
<li><a href="https://developers.google.com/speed/public-dns/cache?hl=fr">for google dns</a></li>
<li><a href="https://1.1.1.1/purge-cache/">for cloudflare dns</a></li>
</ul>
<blockquote>
<p>For real world testing, it's best to use different <code>dex_hostname</code> and <code>paas_hostname</code> entries that you don't use for one environment (staging or production).</p>
</blockquote>
<h3 id="2-help-kubernetes-on-vscode">Kubernetes on Vscode<a class="headerlink" href="#2-help-kubernetes-on-vscode" title="Permanent link">&para;</a></h3>
<p>To consolidate the debugging of our dev ops environment we can integrate our kubernetes cluster into the vscode IDE.</p>
<p>We will fetch the kubeconfig in our container that embeds K3s and the cluster.</p>
<p>Copy the kube config k3s with :</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#2-help-__codelineno-0-1"></a>docker<span class="w"> </span>cp<span class="w"> </span>node-0:/etc/rancher/rke2/rke2.yaml<span class="w"> </span>~/.kube/config
</code></pre></div>
<p>If you don't have kubectl locally:</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-macos/">For mac</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/">For Wsl / Linux</a></li>
</ul>
<p>Then we check with <code>kubectl cluster-info</code> which should give us the information of the k3s node.</p>
<h5 id="2-help-then-on-vscode-use-these-user-parameters-to-see-and-use-the-cluster">Then on <code>vscode</code> use these user parameters to see and use the cluster<a class="headerlink" href="#2-help-then-on-vscode-use-these-user-parameters-to-see-and-use-the-cluster" title="Permanent link">&para;</a></h5>
<blockquote>
<p>To show the path to home <code>cd ~ &amp;&amp; pwd &amp;&amp; cd -</code></p>
<p><a href="../2-help/.vscode/settings.json">.vscode/settings.json</a>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#2-help-__codelineno-1-1"></a><span class="w">    </span><span class="nt">&quot;vs-kubernetes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#2-help-__codelineno-1-2"></a><span class="w">        </span><span class="nt">&quot;vs-kubernetes.knownKubeconfigs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#2-help-__codelineno-1-3"></a><span class="w">            </span><span class="s2">&quot;&lt;path-to-home&gt;/.kube/config&quot;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#2-help-__codelineno-1-4"></a><span class="w">        </span><span class="p">],</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#2-help-__codelineno-1-5"></a><span class="w">        </span><span class="nt">&quot;vs-kubernetes.kubeconfig&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;&lt;Path-to-home&gt;/.kube/config&quot;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#2-help-__codelineno-1-6"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></p>
</blockquote>
<p>And there you have access to an interface to control your cluster directly from vscode. Use this <code>json</code> configuration as much as you want in your application repositories to have a production-like experience.</p>
<h2 id="2-help-sources">Sources<a class="headerlink" href="#2-help-sources" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/goffinet/packer-kvm/blob/master/http/jammy/user-data">packer-kvm</a></li>
<li><a href="https://mac-blog.org.ua/kubernetes-coredns-wildcard-ingress/">coredns wildcard</a></li>
</ul>
<p>Translated with www.DeepL.com/Translator (free version)</p></section></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "/", "features": ["content.code.copy", "content.action.edit"], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
    
  </body>
</html>